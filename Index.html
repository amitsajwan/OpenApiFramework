<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Execution & DAG</title>
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dagre-d3/0.6.4/dagre-d3.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; background-color: #f4f4f4; }
        .container { display: flex; justify-content: space-between; padding: 20px; }
        #chat, #dag { width: 48%; background: white; padding: 10px; border-radius: 5px; box-shadow: 0px 0px 10px #ccc; }
        #messages { height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; background: #f9f9f9; text-align: left; }
        input { width: 80%; padding: 10px; margin-top: 10px; border: 1px solid #ccc; border-radius: 5px; }
        button { padding: 10px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background: #0056b3; }
        svg { width: 100%; height: 400px; border: 1px solid black; }
    </style>
</head>
<body>

    <h2>API Execution & DAG Visualization</h2>
    <div class="container">
        <div id="chat">
            <h3>Chat</h3>
            <div id="messages"></div>
            <input type="text" id="chatInput" placeholder="Type here..." onkeypress="handleKeyPress(event)">
            <button onclick="sendMessage()">Send</button>
        </div>

        <div id="dag">
            <h3>Execution Flow</h3>
            <svg><g></g></svg>
            <button onclick="confirmSequence()">Confirm & Run</button>
        </div>
    </div>

    <script>
        const ws = new WebSocket("ws://localhost:8000/chat");
        let dagData = { nodes: [], edges: [] };

        ws.onmessage = function(event) {
            const msgDiv = document.getElementById("messages");
            const data = JSON.parse(event.data);

            if (data.message) {
                msgDiv.innerHTML += `<p>${data.message}</p>`;
                msgDiv.scrollTop = msgDiv.scrollHeight;
            }

            if (data.graph) {
                console.log("Received DAG:", data.graph);
                renderDAG(data.graph);
            }
        };

        function sendMessage() {
            const input = document.getElementById("chatInput");
            const message = input.value.trim();
            if (message) {
                ws.send(JSON.stringify({ user_input: message }));
                input.value = "";
            }
        }

        function handleKeyPress(event) {
            if (event.key === "Enter") sendMessage();
        }

        function confirmSequence() {
            ws.send(JSON.stringify({ action: "confirm_sequence", sequence: dagData.nodes.map(n => n.id) }));
        }

        function renderDAG(data) {
            if (!data || !data.nodes || !data.edges) {
                console.error("Invalid DAG data received:", data);
                return;
            }

            d3.select("svg").selectAll("*").remove();

            const g = new dagreD3.graphlib.Graph().setGraph({ rankdir: "LR" });

            data.nodes.forEach(node => {
                g.setNode(node.id, { label: node.id, width: 120, height: 40, style: "fill: lightblue; stroke: #000;" });
            });

            data.edges.forEach(edge => {
                g.setEdge(edge.source, edge.target, { arrowhead: "vee" });
            });

            const svg = d3.select("svg"),
                  inner = svg.select("g");

            if (inner.empty()) {
                inner = svg.append("g");
            }

            const render = new dagreD3.render();
            render(inner, g);

            svg.call(d3.zoom().on("zoom", ({ transform }) => inner.attr("transform", transform)));
        }
    </script>

</body>
</html>
